---
title: "Bayesian networks."
---

```{r}
library(bnlearn)
```

```{r}
rawg <- read.csv("rawg.csv")
# TODO: przemyśleć unknown!
rawg[rawg$esrb_rating == "", ]["esrb_rating"] <- "unknown"
```

```{r}
# P(ESRB | G)
sorted_esrb_ratings <- c("adults-only", "mature", "teen", "everyone-10-plus", "everyone")
esrb_ratings <- unique(rawg$esrb_rating)
esrb_ratings_distribution <- table(rawg$esrb_rating) / length(rawg$esrb_rating)

get_esrb_probability <- function(esrb_rating, game) {
  game_esrb_rating <- game$esrb_rating
  game_esrb_rating_idx <- match(game_esrb_rating, sorted_esrb_ratings)
  esrb_rating_idx <- match(esrb_rating, sorted_esrb_ratings)
  if(is.na(game_esrb_rating_idx) || is.na(esrb_rating_idx)) {
    return(as.vector(esrb_ratings_distribution[[esrb_rating]]))
  }
  else {
    esrb_ratings_distance <- abs(esrb_rating_idx - game_esrb_rating_idx)
    unknown_rating_probability <- esrb_ratings_distribution["unknown"] + esrb_ratings_distribution["rating-pending"]
    distance_nonlinear <- function(distance) { 2^(1-distance) }
    normalization_value <- sum(distance_nonlinear(abs(1:length(sorted_esrb_ratings) - game_esrb_rating_idx)))
    probability <- distance_nonlinear(esrb_ratings_distance) / normalization_value
    return(probability * (1 - unknown_rating_probability))
  }
}
```

```{r}
esrb_probabilities <- c()
for(rowname in rownames(rawg)){
  row <- rawg[rowname, ]
  for(esrb_rating in esrb_ratings) {
    esrb_probabilities <- c(esrb_probabilities, get_esrb_probability(esrb_rating, row))
  }
}
```

```{r}
dag = model2network("[ESRB|G][G]")
G.lv <- rawg$slug
ESRB.lv <- esrb_ratings
# Uniform prior distribution for G
G.prob <- rep(1/length(rawg$slug), times=length(rawg$slug))
ESRB.prob <- array(esrb_probabilities, dim = c(length(esrb_ratings), length(rawg$slug)), dimnames = list(ESRB = ESRB.lv, G = G.lv))
plot(dag)
View(ESRB.prob)
```